---
# This Part will do the following:
# - Install Google Chrome
# - Install and configure keyd
# - Install and configure Powerline Fonts
# - Install HomeBase RootCA

- name: Create file storage directory if it doesn't exist
  become: true
  ansible.builtin.file:
    path: "{{ storage_directory }}"
    state: directory
    owner: root
    group: root 
    mode: '0755'

# - name: Download Chrome if it doesn't exist
#  become: true
#  command: wget -O "{{ chrome_directory }}" "{{ chrome_url }}"
#  args:
#    creates: "{{ chrome_directory }}"
  
# - name: Install Google Chrome package if it isn't already
#  apt:
#    deb: "{{ chrome_directory }}"
#    state: present
#  become: true

- name: Restore SELinux context on /tmp
  command: "restorecon -Rv /tmp"
  become: true  # Required to run restorecon as root

- name: Download Google Chrome .deb package
  command:
    cmd: "curl -LO -o /tmp/google-chrome-stable_current_amd64.deb https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb"
  register: curl_output
  changed_when: curl_output.rc != 0
  failed_when: curl_output.rc != 0

- name: Install Google Chrome
  command:
    cmd: "dpkg -i /tmp/google-chrome-stable_current_amd64.deb"

- name: Fix any dependency issues
  apt:
    name: "*"
    state: present
    update_cache: yes
  when: download_result.changed  #Run this when we installed the .deb.

- name: Ensure git is installed
  apt:
    name: git
    state: present
  become: true

- name: Clone or update keyd repository if needed
  git:
    repo: "{{ keyd_url }}" 
    dest: "{{ keyd_directory }}" 
    update: yes # Optional: Update the repository if it already exists
    force: yes # Optional: Force checkout even if there are local changes
  become: true

- name: Ensure build dependencies are installed
  apt:
    name: make
    state: present
  become: true

- name: Build keyd if not already compiled
  become: true
  block:
    - name: Check if keyd binary already exists
      ansible.builtin.stat:
        path: "{{ keyd_directory }}/keyd"  # Adjust the path to the main keyd executable
      register: keyd_binary_status

    - name: Build keyd
      ansible.builtin.command: make
      args:
        chdir: "{{ keyd_directory }}"
      when: not keyd_binary_status.stat.exists
  become: true

- name: Install keyd if not already installed
  become: true
  block:
    - name: Check if keyd is already installed (check for binary in /usr/local/bin or similar)
      ansible.builtin.stat:
        path: "/usr/local/bin/keyd"  # Adjust this path to where 'make install' puts the binary
      register: keyd_installed_check

    - name: Install keyd
      ansible.builtin.command: "make install"
      args:
        chdir: "{{ keyd_directory }}"
      when: not keyd_installed_check.stat.exists
  become: true

- name: Copy Baseline keyd configuration to /etc
  ansible.builtin.copy:
    src: files/keyd/default.conf
    dest: /etc/keyd/default.conf
    owner: root
    group: root
    mode: '0644'
  become: true

- name: Enable and start keyd service
  systemd:
    name: keyd
    enabled: true
    state: started
  become: true

- name: Define Powerline Fonts variables
  become: false
  set_fact:
    powerline_url: "https://github.com/powerline/fonts.git"
    powerline_directory: "/opt/powerline-fonts" # Temporary clone location
    system_fonts_dir: "/usr/share/fonts/powerline" # System-wide font directory

- name: Install fontconfig
  become: true
  apt:
    name: fontconfig
    state: present

- name: Clone Powerline Fonts repository
  become: true
  git:
    repo: "{{ powerline_url }}"
    dest: "{{ powerline_directory }}"
    update: yes
    depth: 1

- name: Create Powerline fonts directory system-wide
  become: true
  file:
    path: "{{ system_fonts_dir }}"
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Find Powerline font files
  become: false
  find:
    paths: "{{ powerline_directory }}"
    patterns:
      - "*.ttf"
      - "*.otf"
    recurse: yes
  register: powerline_fonts_found

- name: Copy Powerline font files to system directory
  become: true
  copy:
    src: "{{ item.path }}"
    dest: "{{ system_fonts_dir }}/"
    owner: root
    group: root
    mode: '0644'
    remote_src: yes  # Add this line
  loop: "{{ powerline_fonts_found.files }}"

- name: Update font cache system-wide
  become: true
  command: fc-cache -fv

- name: Remove temporary Powerline fonts directory (optional)
  become: true
  file:
    path: "{{ powerline_directory }}"
    state: absent

- name: ensure ca-certificates package is installed
  apt:
    name: ca-certificates
    state: present
    update_cache: yes
  become: yes

#- name: (optional) remove old certs that are no longer needed
#  file:
#    path: "/usr/local/share/ca-certificates/{{ item }}"
#    state: absent
#  loop: "{{ rootca_old_certs }}"
#  become: yes
#  when: rootca_old_certs | length > 0

- name: copy Rootâ€‘CA cert to /usr/local/share/ca-certificates/
  copy:
    src: "{{ rootca_cert_src }}"
    dest: "/usr/local/share/ca-certificates/{{ rootca_cert_name }}"
    mode: '0644'
    owner: root
    group: root
  become: yes
  notify: refresh ca-certificates

- name: Ensure libnss3-tools is installed
  ansible.builtin.package:
    name: libnss3-tools
    state: present
  become: true

- name: Copy HomeBase Root CA certificate
  ansible.builtin.copy:
    src: "{{ rootca_cert_src }}"
    dest: "{{ temp_cert_dest }}"
    mode: '0644'
  become: true

- name: Find all user home directories
  ansible.builtin.find:
    paths: /home
    file_type: directory
    recurse: false
  register: user_homes

- name: Set a fact for home directories
  ansible.builtin.set_fact:
    home_dirs: "{{ user_homes.files | map(attribute='path') | list }}"

- name: Find all Chrome default profile paths
  ansible.builtin.shell: |
    find {{ home_dirs | join(' ') }} -path '*/.pki/nssdb' -type d
  register: chrome_raw
  changed_when: false

- name: Set fact for Chrome profile paths
  ansible.builtin.set_fact:
    chrome_profiles: "{{ chrome_raw.stdout_lines }}"
  when: chrome_raw.stdout_lines | length > 0

- name: Delete existing RootCA (if it exists)
  ansible.builtin.command: >
    certutil -D -n "{{ rootca_cert_name }}"
    -d "sql:{{ item }}"
  become: true
  loop: "{{ chrome_profiles | default([]) }}"
  ignore_errors: true

- name: Add the RootCA to each Chrome profile's NSS database
  ansible.builtin.command: >
    certutil -A -n "{{ rootca_cert_name }}"
    -t "C,," -i "{{ temp_cert_dest }}"
    -d "sql:{{ item }}"
  become: true
  loop: "{{ chrome_profiles | default([]) }}"
  changed_when: true


